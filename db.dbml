// Clinic Scheduling SaaS - Database Schema
// PostgreSQL 16 with pgvector extension
//
// Key Features:
// - UUID primary keys
// - TIMESTAMPTZ for timezone handling
// - Soft delete with deleted_at timestamps
// - JSONB for flexible data storage
// - Denormalized fields for query performance

// ============================================
// CLINIC & ORGANIZATION TABLES
// ============================================

Table clinics [headercolor: #175e7a] {
  id uuid [pk, not null]
  name varchar(255) [not null]
  contact_email varchar(255)
  contact_phone varchar(20)
  business_hours jsonb [note: 'Store operating hours per day of week']
  timezone varchar(50) [not null, default: 'America/Sao_Paulo', note: 'IANA timezone for UTC conversions']
  average_appointment_value decimal(10,2) [note: 'For ROI calculations']
  subscription_id uuid [ref: > subscriptions.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz [note: 'Soft delete timestamp']

  indexes {
    subscription_id
    deleted_at
  }

}

Table clinic_locations [headercolor: #175e7a] {
  id uuid [pk, not null]
  clinic_id uuid [not null, ref: > clinics.id]
  name varchar(255) [not null]
  address_street varchar(255)
  address_city varchar(100)
  address_state varchar(2)
  address_zip varchar(10)
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz [note: 'Soft delete timestamp']

  indexes {
    clinic_id
    (clinic_id, deleted_at) [note: 'Composite index for active locations by clinic']
    deleted_at
  }
}

Table subscriptions [headercolor: #d97706] {
  id uuid [pk, not null]
  tier varchar(50) [not null, note: 'ENUM: basic, professional, enterprise']
  status varchar(50) [not null, default: 'active', note: 'ENUM: active, past_due, cancelled']
  billing_cycle_start date [not null]
  billing_cycle_end date [not null]
  payment_method varchar(50) [note: 'credit_card, pix']
  payment_provider_customer_id varchar(255)
  monthly_price decimal(10,2) [not null]
  whatsapp_messages_included integer [not null]
  whatsapp_messages_used integer [not null, default: 0]
  max_providers integer [not null]
  current_providers integer [not null, default: 0]
  next_billing_date date [not null]
  cancelled_at timestamptz
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz [note: 'Soft delete timestamp']

  indexes {
    status
    next_billing_date
    deleted_at
  }

  Note: '''
  CHECK CONSTRAINTS:
  - billing_cycle_end > billing_cycle_start
  - monthly_price >= 0
  - whatsapp_messages_used >= 0
  - whatsapp_messages_used <= whatsapp_messages_included
  - current_providers <= max_providers
  '''
}

// ============================================
// USER & PROVIDER TABLES
// ============================================

Table users [headercolor: #175e7a] {
  id uuid [pk, not null]
  clinic_id uuid [not null, ref: > clinics.id]
  email varchar(255) [not null, note: 'UNIQUE WHERE deleted_at IS NULL']
  password_hash varchar(255)
  name varchar(255) [not null]
  role varchar(50) [not null, note: 'ENUM: USER, ADMIN']
  email_verified boolean [not null, default: false]
  last_login_at timestamptz
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz [note: 'Soft delete timestamp']

  indexes {
    clinic_id
    (clinic_id, role)
    deleted_at
  }

  Note: 'UNIQUE INDEX: email WHERE deleted_at IS NULL (partial unique constraint)'
}

Table providers [headercolor: #175e7a] {
  id uuid [pk, not null]
  clinic_id uuid [not null, ref: > clinics.id]
  user_id uuid [ref: > users.id, note: 'Optional link to user account']
  name varchar(255) [not null]
  specialty varchar(100)
  default_appointment_duration integer [not null, default: 30, note: 'Duration in minutes']
  working_hours jsonb [note: 'Store working schedule per location. Validated: jsonb_typeof = object']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz [note: 'Soft delete timestamp']

  indexes {
    clinic_id
    deleted_at
  }

  Note: '''
  GIN INDEX: working_hours (for JSONB queries)
  '''
}

Table provider_locations [headercolor: #30a85f] {
  id uuid [pk, not null]
  provider_id uuid [not null, ref: > providers.id]
  location_id uuid [not null, ref: > clinic_locations.id]
  created_at timestamptz [not null, default: `now()`]

  indexes {
    (provider_id, location_id) [unique]
    provider_id
    location_id
  }
}

// ============================================
// PATIENT TABLE
// ============================================

Table patients [headercolor: #175e7a] {
  id uuid [pk, not null]
  clinic_id uuid [not null, ref: > clinics.id]
  name varchar(255) [not null]
  phone varchar(20) [not null, note: 'WhatsApp contact']
  email varchar(255)
  date_of_birth date
  medical_record_id varchar(50) [note: 'Optional clinic internal ID']
  notes text
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz [note: 'Soft delete timestamp']

  indexes {
    clinic_id
    (clinic_id, phone)
    (clinic_id, name) [note: 'For patient search by name']
    (clinic_id, medical_record_id)
    deleted_at
  }
}

// ============================================
// APPOINTMENT TABLES
// ============================================

Table appointments [headercolor: #175e7a] {
  id uuid [pk, not null]
  clinic_id uuid [not null, ref: > clinics.id]
  patient_id uuid [not null, ref: > patients.id]
  provider_id uuid [not null, ref: > providers.id]
  location_id uuid [ref: > clinic_locations.id]

  // CONSOLIDATED TIMESTAMPTZ (breaking change from date + time)
  appointment_start timestamptz [not null, note: 'Stored in UTC, converted to clinic timezone for display']
  appointment_end timestamptz [not null, note: 'Stored in UTC, converted to clinic timezone for display']

  // DENORMALIZED FIELDS (for query performance)
  patient_name varchar(255) [not null, note: 'Denormalized from patients.name']
  patient_phone varchar(20) [not null, note: 'Denormalized from patients.phone']
  provider_name varchar(255) [not null, note: 'Denormalized from providers.name']

  status varchar(50) [not null, default: 'scheduled', note: 'ENUM: scheduled, confirmed, checked_in, completed, no_show, cancelled']
  notes text
  booking_source varchar(50) [note: 'ENUM: manual, public_link, api']
  confirmed_at timestamptz
  checked_in_at timestamptz
  created_by uuid [ref: > users.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz [note: 'Soft delete timestamp']

  indexes {
    clinic_id
    patient_id
    provider_id
    status
    deleted_at

    // PARTIAL UNIQUE INDEX (soft delete aware)
    (provider_id, appointment_start) [note: 'UNIQUE WHERE deleted_at IS NULL - Prevent double booking']

    // PARTIAL INDEX for active appointments
    (clinic_id, appointment_start) [note: 'WHERE deleted_at IS NULL AND status IN (scheduled, confirmed)']

    // PARTIAL INDEX for provider schedule
    (provider_id, appointment_start) [note: 'WHERE deleted_at IS NULL AND status NOT IN (cancelled, no_show)']

    // COMPOSITE INDEX with INCLUDE (PostgreSQL 11+)
    (clinic_id, appointment_start) [note: 'INCLUDE (patient_id, provider_id, status, patient_name, provider_name)']
    (provider_id, appointment_start) [note: 'INCLUDE (appointment_end, status, deleted_at)']
  }

  Note: '''
  - Monthly partitions
  - Retain 24 months hot, archive older
  - Function: create_next_appointment_partition() for automation

  CHECK CONSTRAINTS:
  - appointment_end > appointment_start
  - status IN (scheduled, confirmed, checked_in, completed, no_show, cancelled)

  DENORMALIZATION:
  - patient_name, patient_phone, provider_name auto-populated via Prisma middleware
  - Sync functions: updateAppointmentsForPatient(), updateAppointmentsForProvider()
  '''
}

Table appointment_status_events [headercolor: #30a85f] {
  id uuid [pk, not null]
  appointment_id uuid [not null, ref: > appointments.id]
  previous_status varchar(50)
  new_status varchar(50) [not null]
  changed_by uuid [ref: > users.id]
  changed_at timestamptz [not null, default: `now()`]
  notes text

  indexes {
    appointment_id
    (appointment_id, changed_at)
  }
}

Table blocked_time_slots [headercolor: #30a85f] {
  id uuid [pk, not null]
  provider_id uuid [not null, ref: > providers.id]
  location_id uuid [ref: > clinic_locations.id]
  start_datetime timestamptz [not null]
  end_datetime timestamptz [not null]
  reason varchar(255) [note: 'holiday, emergency, personal']
  created_by uuid [ref: > users.id]
  created_at timestamptz [not null, default: `now()`]

  indexes {
    provider_id
    (provider_id, start_datetime, end_datetime)
    (start_datetime, end_datetime) [note: 'For overlap detection']
  }

}

// ============================================
// WHATSAPP & COMMUNICATION 
// ============================================

Table whatsapp_messages [headercolor: #30a85f] {
  id uuid [pk, not null]
  clinic_id uuid [not null, ref: > clinics.id]
  appointment_id uuid [ref: > appointments.id]
  patient_id uuid [not null, ref: > patients.id]
  message_type varchar(50) [not null, note: 'ENUM: confirmation_request, booking_confirmation, reminder, cancellation']
  phone_number varchar(20) [not null]
  message_content text [not null]
  status varchar(50) [not null, note: 'ENUM: pending, sent, delivered, failed, replied']
  external_message_id varchar(255) [note: 'WhatsApp API message ID']
  patient_response text
  sent_at timestamptz
  delivered_at timestamptz
  replied_at timestamptz
  failed_reason text
  created_at timestamptz [not null, default: `now()`]

  indexes {
    clinic_id
    appointment_id
    patient_id
    status
    (clinic_id, created_at)

    // PARTIAL INDEX for pending messages
    (clinic_id, created_at) [note: 'WHERE status = pending']

    // COMPOSITE with INCLUDE
    (clinic_id, created_at) [note: 'INCLUDE (appointment_id, status, message_type)']
  }

  Note: '''
  - Monthly partitions
  - Retain 6 months, archive older
  '''
}

Table patient_consents [headercolor: #30a85f] {
  id uuid [pk, not null]
  patient_id uuid [not null, ref: > patients.id]
  consent_type varchar(50) [not null, note: 'whatsapp_communication']
  consent_method varchar(50) [note: 'verbal, written, digital']
  granted_at timestamptz [not null]
  revoked_at timestamptz
  created_at timestamptz [not null, default: `now()`]

  indexes {
    patient_id
    (patient_id, consent_type)
  }
}

// ============================================
// BILLING & SUBSCRIPTION TRACKING
// ============================================

Table billing_history [headercolor: #d97706] {
  id uuid [pk, not null]
  subscription_id uuid [not null, ref: > subscriptions.id]
  billing_date date [not null]
  amount decimal(10,2) [not null]
  status varchar(50) [not null, note: 'ENUM: pending, paid, failed, refunded']
  payment_method varchar(50)
  transaction_id varchar(255)
  invoice_url varchar(500)
  failure_reason text
  retry_count integer [default: 0]
  paid_at timestamptz
  created_at timestamptz [not null, default: `now()`]

  indexes {
    subscription_id
    (subscription_id, billing_date)
    status
  }

  Note: '''
  CHECK CONSTRAINTS:
  - amount >= 0
  - retry_count >= 0
  '''
}

// ============================================
// ANALYTICS & REPORTING 
// ============================================

Table analytics_snapshots [headercolor: #9333ea] {
  id uuid [pk, not null]
  clinic_id uuid [not null, ref: > clinics.id]
  snapshot_date date [not null]
  period_start date [not null]
  period_end date [not null]
  total_appointments integer [not null, default: 0]
  completed_appointments integer [not null, default: 0]
  no_show_count integer [not null, default: 0]
  no_show_percentage decimal(5,2)
  confirmed_appointments integer [not null, default: 0]
  revenue_impact decimal(10,2) [note: 'Estimated revenue saved from prevented no-shows']
  utilization_by_provider jsonb [note: 'Provider-level utilization stats. Validated: jsonb_typeof = object']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    clinic_id
    (clinic_id, snapshot_date) [unique]
    (clinic_id, period_start, period_end)
  }

  Note: '''
  - Quarterly partitions

  GIN INDEX: utilization_by_provider
  '''
}

// ============================================
// SUPPORT & AUDIT 
// ============================================

Table support_tickets [headercolor: #9333ea] {
  id uuid [pk, not null]
  clinic_id uuid [not null, ref: > clinics.id]
  created_by uuid [not null, ref: > users.id]
  subject varchar(255) [not null]
  description text [not null]
  priority varchar(50) [not null, default: 'normal', note: 'ENUM: low, normal, high, critical']
  status varchar(50) [not null, default: 'open', note: 'ENUM: open, in_progress, resolved, closed']
  assigned_to varchar(255) [note: 'Support agent name/email']
  resolution_notes text
  resolved_at timestamptz
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz [note: 'Soft delete timestamp']

  indexes {
    clinic_id
    created_by
    status
    priority
    (clinic_id, status)
    deleted_at
  }
}

Table audit_logs [headercolor: #9333ea] {
  id uuid [pk, not null]
  clinic_id uuid [not null, ref: > clinics.id]
  user_id uuid [ref: > users.id]
  action_type varchar(50) [not null, note: 'ENUM: view, create, update, delete, export']
  resource_type varchar(50) [not null, note: 'patient, appointment, user, etc.']
  resource_id uuid
  ip_address varchar(45)
  user_agent text
  details jsonb [note: 'Additional context. Validated: jsonb_typeof = object']
  created_at timestamptz [not null, default: `now()`]

  indexes {
    clinic_id
    user_id
    (clinic_id, created_at)
    (resource_type, resource_id)
    action_type
  }

  Note: '''
  - Monthly partitions
  - Retain 12 months, archive older

  GIN INDEX: details
  '''
}

// ============================================
// PUBLIC BOOKING
// ============================================

Table public_booking_settings [headercolor: #30a85f] {
  id uuid [pk, not null]
  clinic_id uuid [not null, ref: > clinics.id, note: 'UNIQUE WHERE deleted_at IS NULL']
  public_url_slug varchar(100) [not null, note: 'UNIQUE WHERE deleted_at IS NULL']
  min_booking_notice_hours integer [default: 2, note: 'Minimum hours in advance for booking']
  max_booking_days_ahead integer [default: 30]
  allow_same_day_booking boolean [default: true]
  custom_welcome_message text
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz [note: 'Soft delete timestamp']

  indexes {
    deleted_at
  }

  Note: '''
  UNIQUE INDEXES with soft delete awareness:
  - public_url_slug WHERE deleted_at IS NULL
  - clinic_id WHERE deleted_at IS NULL
  '''
}

// ============================================
// MATERIALIZED VIEW: Clinic Daily Stats
// ============================================

Note: '''
MATERIALIZED VIEW: mv_clinic_daily_stats

CREATE MATERIALIZED VIEW mv_clinic_daily_stats AS
SELECT
  clinic_id,
  appointment_start::date as appointment_date,
  COUNT(*) FILTER (WHERE status = COMPLETED) as completed_count,
  COUNT(*) FILTER (WHERE status = NO_SHOW) as no_show_count,
  ROUND(
    COUNT(*) FILTER (WHERE status = NO_SHOW)::numeric /
    NULLIF(COUNT(*) FILTER (WHERE status IN (COMPLETED, NO_SHOW))::numeric, 0) * 100,
    2
  ) as no_show_percentage
FROM appointments
WHERE deleted_at IS NULL
GROUP BY clinic_id, appointment_start::date;

CREATE UNIQUE INDEX mv_clinic_daily_stats_unique
  ON mv_clinic_daily_stats(clinic_id, appointment_date);

-- Refresh Strategy: Daily at 2 AM via cron/scheduler
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_clinic_daily_stats;
'''

// ============================================
// AUTHENTICATION TABLES (existing)
// ============================================

Note: '''
EXISTING AUTH TABLES (managed by Prisma):
- refresh_tokens
- email_verify_tokens
- password_reset_tokens
- oauth_accounts

These tables already exist and will be updated separately
to use UUID and TIMESTAMPTZ in Prisma schema.
'''
